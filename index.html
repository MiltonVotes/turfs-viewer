<!DOCTYPE html>
<html>
<head>
  <title>Turfs Viewer</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-extra-markers/dist/css/leaflet.extra-markers.min.css"
  />
  <style>
    #map { height: 70vh; }
    #precinct-toggles, #view-toggle { margin: 10px; }
    #precinct-container {
      position: absolute; top: 10px; left: 10px; background: white; padding: 10px;
      border: 1px solid #ccc; z-index: 1001; box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    #legend {
      position: absolute; top: 10px; right: 10px; background: white; padding: 10px;
      border: 1px solid #ccc; z-index: 1001; box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
    .legend-icon { width: 20px; height: 20px; margin-right: 8px; }

    #table-view { display: none; margin: 10px; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; table-layout: auto; }
    th, td {
      border: 1px solid #ccc; padding: 5px; font-family: monospace; font-size: 13px;
      white-space: nowrap;
    }
    tr:hover { background-color: #f0f0f0; cursor: pointer; }

    .modal-field { margin: 5px 0; display: flex; align-items: center; }
    .modal-field b { display: inline-block; width: 130px; }
    #modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border: 2px solid black; display: none;
      z-index: 2000; max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .modal-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
    #log { padding: 10px; background: #f0f0f0; border-top: 1px solid #ccc;
      font-family: monospace; max-height: 20vh; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="precinct-container">
    <details open>
      <summary><b>Precincts</b></summary>
      <div id="precinct-toggles"></div>
    </details>
    <button id="view-toggle">View: Map</button>
  </div>

  <div id="legend">
    <details open>
      <summary><b>Legend</b></summary>
      <div class="legend-item"><span class="legend-icon">★</span> Voted_Town starts with "25"</div>
      <div class="legend-item"><span class="legend-icon">●</span> Voted_Town starts with "--"</div>
    </details>
  </div>

  <div id="map"></div>
  <div id="table-view"><table id="data-table"></table></div>

  <div id="modal">
    <div id="card-content"></div>
    <div class="modal-field">
      <b>Phone:</b> <input type="text" id="phone-input">
    </div>
    <div class="modal-field">
      <b>Email:</b> <input type="text" id="email-input">
    </div>
    <div class="modal-field">
      <b>Visited:</b>
      <select id="visit-status">
        <option value="">-- Select --</option>
        <option value="Not Visited">Not Visited</option>
        <option value="No Answer">No Answer</option>
        <option value="Spoke to Someone">Spoke to Someone</option>
      </select>
    </div>
    <div class="modal-field">
      <b>Supports:</b>
      <select id="support-status">
        <option value="">-- Select --</option>
        <option value="Supports">Supports</option>
        <option value="Declined">Declined</option>
        <option value="Unsure">Unsure</option>
        <option value="Already Involved">Already Involved</option>
      </select>
    </div>
    <div class="modal-field">
      <b>Notes:</b>
      <input type="text" id="notes-input" />
    </div>
    <div class="modal-buttons">
      <button id="close-btn">Close</button>
      <button id="save-btn">Save</button>
    </div>
  </div>

  <div id="log"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-extra-markers/dist/js/leaflet.extra-markers.min.js"></script>
  <script>
    const map = L.map('map').setView([42.25, -71.07], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allMarkers = [], markerMap = new Map(), selectedPrecincts = {}, currentData = {};

    function jitter(coord, amount = 0.0001) {
      return coord + (Math.random() * 2 - 1) * amount;
    }

    function log(msg) {
      const el = document.getElementById('log');
      el.innerText += `\n${msg}`;
      el.scrollTop = el.scrollHeight;
    }

    function getIcon(voter) {
      const isStar = voter.Voted_Town && voter.Voted_Town.startsWith("25");
      return L.ExtraMarkers.icon({
        icon: 'fa-number',
        number: voter.Num_Voters || '',
        markerColor: 'blue',
        shape: isStar ? 'star' : 'circle',
        prefix: 'fa'
      });
    }

    function createMarker(voter) {
      const lat = jitter(parseFloat(voter.Latitude));
      const lng = jitter(parseFloat(voter.Longitude));
      const marker = L.marker([lat, lng], { icon: getIcon(voter) }).addTo(map);
      marker.voterData = voter;
      marker.on('click', () => showModal(voter));
      allMarkers.push(marker);
      markerMap.set(voter.Voter_ID, marker);
    }

    function renderRows() {
      const table = document.getElementById('data-table');
      table.innerHTML = '';
      const keys = ['Voter_ID','Name','Address','Age','Party','Occupation','Precinct','Turf','Voted_Town','Voted_MBTA','Voted_State','Num_Voters','Phone','Email','Visit_Status','Support_Status','Notes'];
      const header = document.createElement('tr');
      keys.forEach(k => {
        const th = document.createElement('th');
        th.style.whiteSpace = 'nowrap';
        th.textContent = k;
        header.appendChild(th);
      });
      table.appendChild(header);
      Object.values(currentData).flat().forEach(voter => {
        const row = document.createElement('tr');
        row.onclick = () => showModal(voter);
        keys.forEach(k => {
          const td = document.createElement('td');
          td.style.whiteSpace = 'nowrap';
          td.textContent = voter[k] || '';
          row.appendChild(td);
        });
        table.appendChild(row);
      });
    }

    function showModal(voter) {
      currentVoter = { ...voter };
      const labels = {
        Voter_ID: 'Voter ID', Voted_Town: 'Town Votes', Voted_MBTA: 'MBTA',
        Voted_State: 'State Votes', Num_Voters: 'Household'
      };
      const fields = ['Voter_ID','Name','Address','Age','Party','Occupation','Precinct','Turf','Voted_Town','Voted_MBTA','Voted_State','Num_Voters'];
      const html = fields.map(f => `<div class="modal-field"><b>${labels[f] || f}:</b> ${voter[f] || ''}</div>`).join('');
      document.getElementById('card-content').innerHTML = html;
      document.getElementById('phone-input').value = voter.Phone || '';
      document.getElementById('email-input').value = voter.Email || '';
      document.getElementById('visit-status').value = voter.Visit_Status || '';
      document.getElementById('support-status').value = voter.Support_Status || '';
      document.getElementById('notes-input').value = voter.Notes || '';
      document.getElementById('modal').style.display = 'block';
    }

    document.getElementById('close-btn').onclick = () => {
      document.getElementById('modal').style.display = 'none';
    };

    document.getElementById('save-btn').onclick = async () => {
      if (!currentVoter) return;
      currentVoter.Phone = document.getElementById('phone-input').value;
      currentVoter.Email = document.getElementById('email-input').value;
      currentVoter.Visit_Status = document.getElementById('visit-status').value;
      currentVoter.Support_Status = document.getElementById('support-status').value;
      currentVoter.Notes = document.getElementById('notes-input').value;

      log("Would POST: " + JSON.stringify(currentVoter));
      document.getElementById('modal').style.display = 'none';
    };

    document.getElementById('view-toggle').onclick = () => {
      const mapDiv = document.getElementById('map');
      const tableDiv = document.getElementById('table-view');
      const btn = document.getElementById('view-toggle');
      if (mapDiv.style.display === 'none') {
        mapDiv.style.display = 'block'; tableDiv.style.display = 'none'; btn.textContent = 'View: Map';
      } else {
        mapDiv.style.display = 'none'; tableDiv.style.display = 'block'; btn.textContent = 'View: Rows';
        renderRows();
      }
    };

    async function loadPrecincts() {
      const resp = await fetch('sheets_urls.json');
      const urls = await resp.json();
      const container = document.getElementById('precinct-toggles');
      Object.entries(urls).forEach(([label, url]) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.onclick = async () => {
          btn.classList.toggle('selected');
          if (selectedPrecincts[label]) {
            selectedPrecincts[label] = false;
            currentData[label] = [];
            allMarkers = allMarkers.filter(m => {
              if (m.voterData.Precinct === label) {
                map.removeLayer(m);
                return false;
              }
              return true;
            });
            renderRows();
          } else {
            selectedPrecincts[label] = true;
            log("Fetching: " + url);
            const data = await fetch(url).then(res => res.json());
            log(`Fetched ${data.length} rows`);
            currentData[label] = data;
            data.forEach(createMarker);
            renderRows();
          }
        };
        container.appendChild(btn);
      });
    }

    loadPrecincts();
  </script>
</body>
</html>
