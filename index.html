<!DOCTYPE html>
<html>
<head>
  <title>Turfs Viewer</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    #map { height: 80vh; }
    .dropdown-submenu {
      position: relative;
    }
    .dropdown-submenu .dropdown-menu {
      top: 0;
      left: 100%;
      margin-left: .1rem;
      margin-right: .1rem;
    }
    #legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-family: Arial, sans-serif;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1001;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="dropdown m-3">
    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Select Sheet
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="sheet-dropdown"></ul>
  </div>

  <div id="map"></div>
  <div id="legend">
    <details open>
      <summary><b>Legend</b></summary>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue.png"> Not Visited</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"> No Answer</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/green.png"> Supports</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/red.png"> Declined</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/yellow.png"> Unsure</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/purple.png"> Already Involved</div>
    </details>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    const map = L.map('map').setView([42.25, -71.07], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allMarkers = [], markerMap = new Map(), currentSheetUrl = null;

    function jitter(coord, amount = 0.0001) {
      return coord + (Math.random() * 2 - 1) * amount;
    }

    function getColor(visitStatus, supportStatus) {
      if (visitStatus === 'Not Visited') return 'blue';
      if (visitStatus === 'No Answer') return 'blue-dot';
      if (visitStatus === 'Spoke to Someone') {
        switch (supportStatus) {
          case 'Supports': return 'green';
          case 'Declined': return 'red';
          case 'Unsure': return 'yellow';
          case 'Already Involved': return 'purple';
          default: return 'blue-dot';
        }
      }
      return 'gray';
    }

    function clearMarkers() {
      allMarkers.forEach(m => map.removeLayer(m));
      allMarkers = [];
      markerMap.clear();
    }

    async function loadSheet(url) {
      clearMarkers();
      try {
        const data = await fetch(url).then(r => r.json());
        data.forEach(voter => {
          if (!voter.Latitude || !voter.Longitude) return;
          const lat = jitter(parseFloat(voter.Latitude));
          const lng = jitter(parseFloat(voter.Longitude));
          const color = getColor(voter.Visit_Status, voter.Support_Status);
          const marker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}.png`,
              iconSize: [32, 32], iconAnchor: [16, 32]
            })
          }).addTo(map);
          marker.voterData = voter;
          allMarkers.push(marker);
          markerMap.set(voter.Row, marker);
        });
      } catch (err) {
        alert('Failed to load sheet: ' + err.message);
      }
    }

    async function populateMenu() {
      const resp = await fetch('sheets_urls.json');
      const data = await resp.json();
      const dropdown = document.getElementById('sheet-dropdown');
      dropdown.innerHTML = '';

      for (const [label, value] of Object.entries(data)) {
        if (typeof value === 'string') {
          const item = document.createElement('a');
          item.className = 'dropdown-item';
          item.href = '#';
          item.textContent = label;
          item.onclick = () => loadSheet(value);
          dropdown.appendChild(item);
        } else {
          const li = document.createElement('li');
          li.className = 'dropdown-submenu';
          const a = document.createElement('a');
          a.className = 'dropdown-item dropdown-toggle';
          a.href = '#';
          a.textContent = label;

          const submenu = document.createElement('ul');
          submenu.className = 'dropdown-menu';
          for (const [sublabel, url] of Object.entries(value)) {
            const subItem = document.createElement('a');
            subItem.className = 'dropdown-item';
            subItem.href = '#';
            subItem.textContent = sublabel;
            subItem.onclick = () => loadSheet(url);
            submenu.appendChild(subItem);
          }
          li.appendChild(a);
          li.appendChild(submenu);
          dropdown.appendChild(li);
        }
      }
    }

    $(document).ready(() => {
      $('.dropdown-submenu a.dropdown-toggle').on("click", function(e) {
        e.preventDefault();
        $(this).next('ul').toggle();
        $('.dropdown-submenu ul').not($(this).next()).hide();
        return false;
      });
    });

    populateMenu();
  </script>
</body>
</html>
