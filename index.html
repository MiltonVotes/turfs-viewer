<!DOCTYPE html>
<html>
<head>
  <title>Turfs Viewer</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map { height: 90vh; width: 100%; }
    #controls { margin: 10px; }
    #card {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 10px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      display: none;
    }
    .field { margin: 4px 0; }
    #visitedBtn {
      padding: 6px 12px;
      background: green;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="sheetSelect">Choose Turf Sheet:</label>
    <select id="sheetSelect"></select>
  </div>
  <div id="map"></div>
  <div id="card">
    <div id="cardContent"></div>
    <button id="visitedBtn">Mark Visited</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([42.25, -71.07], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sheetSelect = document.getElementById('sheetSelect');
    const card = document.getElementById('card');
    const cardContent = document.getElementById('cardContent');
    const visitedBtn = document.getElementById('visitedBtn');
    let currentCard = null;
    let allMarkers = [];

    fetch('sheet_urls.json')
      .then(res => res.json())
      .then(urls => {
        for (const name in urls) {
          const opt = document.createElement('option');
          opt.value = urls[name];
          opt.textContent = name;
          sheetSelect.appendChild(opt);
        }
      });

    sheetSelect.addEventListener('change', async () => {
      const url = sheetSelect.value;
      allMarkers.forEach(m => map.removeLayer(m));
      allMarkers = [];

      try {
        const res = await fetch(url + '?action=get');
        const data = await res.json();

        data.forEach(voter => {
          if (!voter.Latitude || !voter.Longitude) return;

          const lat = parseFloat(voter.Latitude);
          const lng = parseFloat(voter.Longitude);
          const visited = String(voter.Visited || '').toLowerCase() === 'true';

          const marker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl: visited
                ? 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                : 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            })
          }).addTo(map);

          marker.on('click', () => showCard(voter, url));
          allMarkers.push(marker);
        });
      } catch (err) {
        alert('Could not load sheet data. Error: ' + err.message);
      }
    });

    function showCard(voter, url) {
      cardContent.innerHTML = '';
      const fields = [
        'Voter_ID','Name','Address','Age','Party',
        'Precinct','Turf','Occupation',
        'Voted_Town','Voted_MBTA','Voted_State','Visited'
      ];

      fields.forEach(field => {
        const div = document.createElement('div');
        div.className = 'field';
        div.textContent = `${field}: ${voter[field] ?? ''}`;
        cardContent.appendChild(div);
      });

      card.style.display = 'block';
      currentCard = { voter, url };
    }

    visitedBtn.onclick = async () => {
      const { voter, url } = currentCard;
      const payload = {
        Row: parseInt(voter.Row),
        Visited: 'TRUE'
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status === 'success') {
          alert('Marked as visited!');
          location.reload();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (err) {
        alert('Failed to update sheet: ' + err.message);
      }
    };
  </script>
</body>
</html>
