<!DOCTYPE html>
<html>
<head>
  <title>Turfs Viewer</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-extra-markers/dist/css/leaflet.extra-markers.min.css" />
  <style>
    #map { height: 80vh; }
    #precinct-toggle-container {
      position: absolute; top: 10px; left: 10px; background: white;
      border: 1px solid #ccc; padding: 10px; z-index: 1001; max-width: 200px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3); font-family: Arial, sans-serif;
    }
    #precinct-toggle-container summary {
      font-weight: bold; cursor: pointer;
    }
    #precinct-toggle-container button {
      display: block; margin: 5px 0; padding: 5px 10px;
      border: 1px solid #999; background: #eee; cursor: pointer; width: 100%;
      text-align: left;
    }
    #precinct-toggle-container button.active {
      background: #4CAF50; color: white;
    }

    #view-toggle { margin: 10px; position: absolute; top: 10px; right: 10px; z-index: 1001; }

    #modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border: 2px solid black; display: none;
      z-index: 1002; max-width: 90%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
      font-family: 'Courier New', monospace;
    }
    .modal-field { margin: 5px 0; display: flex; align-items: center; }
    .modal-field b { display: inline-block; width: 130px; }
    .modal-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
    .modal-buttons button { padding: 10px 20px; font-size: 16px; }
    select, input[type="text"], textarea { font-size: 14px; flex: 1; }
    textarea { resize: vertical; height: 60px; }

    #legend {
      position: absolute; top: 10px; right: 10px; background: white; padding: 10px;
      border: 1px solid #ccc; font-size: 14px; font-family: Arial, sans-serif;
      box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 1001;
    }
    .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
    .legend-icon { width: 20px; height: 20px; margin-right: 8px; }

    #log {
      padding: 10px; background: #f0f0f0; border-top: 1px solid #ccc;
      font-family: monospace; max-height: 20vh; overflow-y: auto;
    }
  </style>
</head>
<body>
  <details id="precinct-toggle-container" open>
    <summary>Precincts</summary>
    <!-- Toggle buttons injected here -->
  </details>
  <button id="view-toggle">View: Map</button>

  <div id="map"></div>

  <!-- Legend -->
  <div id="legend">
    <details open>
      <summary><b>Legend</b></summary>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue.png"> Not Visited</div>
      <div class="legend-item"><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/green.png"> Supports</div>
      <!-- Add more statuses as needed -->
    </details>
  </div>

  <!-- Modal -->
  <div id="modal">
    <div id="card-content"></div>
    <div class="modal-field">
      <b>Phone:</b><input type="text" id="phone-input" />
    </div>
    <div class="modal-field">
      <b>Email:</b><input type="text" id="email-input" />
    </div>
    <div class="modal-field">
      <b>Notes:</b><textarea id="notes-input"></textarea>
    </div>
    <div class="modal-buttons">
      <button id="close-btn">Close</button>
      <button id="save-btn">Save</button>
    </div>
  </div>

  <div id="log"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-extra-markers/dist/js/leaflet.extra-markers.min.js"></script>
  <script>
    const map = L.map('map').setView([42.25, -71.07], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let precinctButtons = {};
    let allMarkers = [], precinctMarkers = {};
    let currentVoter = null;

    const precincts = ['Precinct 1', 'Precinct 2', 'Precinct 3']; // replace with real list

    precincts.forEach(p => {
      const btn = document.createElement('button');
      btn.textContent = p;
      btn.onclick = () => togglePrecinct(p, btn);
      document.querySelector('#precinct-toggle-container').appendChild(btn);
      precinctButtons[p] = btn;
      precinctMarkers[p] = [];
    });

    function togglePrecinct(precinct, btn) {
      if (btn.classList.contains('active')) {
        precinctMarkers[precinct].forEach(m => map.removeLayer(m));
        btn.classList.remove('active');
      } else {
        precinctMarkers[precinct].forEach(m => map.addLayer(m));
        btn.classList.add('active');
      }
    }

    function makeMarker(voter) {
      let shape = voter.Voted_Town && voter.Voted_Town.startsWith('25') ? 'star' : 'circle';
      let color = 'blue'; // your logic for color
      let label = voter.Num_Voters || '';

      const icon = L.ExtraMarkers.icon({
        icon: 'fa-number',
        number: label,
        markerColor: color,
        shape: shape
      });

      return L.marker([voter.Latitude, voter.Longitude], { icon }).on('click', () => showModal(voter));
    }

    function showModal(voter) {
      currentVoter = { ...voter };
      const fields = [
        { k: 'Voter_ID', label: 'Voter ID' },
        { k: 'Name', label: 'Name' },
        { k: 'Address', label: 'Address' },
        { k: 'Age', label: 'Age' },
        { k: 'Party', label: 'Party' },
        { k: 'Occupation', label: 'Occupation' },
        { k: 'Precinct', label: 'Precinct' },
        { k: 'Turf', label: 'Turf' },
        { k: 'Voted_Town', label: 'Town Votes' },
        { k: 'Voted_MBTA', label: 'MBTA' },
        { k: 'Voted_State', label: 'State Votes' },
        { k: 'Num_Voters', label: 'Household' }
      ];
      document.getElementById('card-content').innerHTML =
        fields.map(f => `<div class="modal-field"><b>${f.label}:</b> ${voter[f.k] || ''}</div>`).join('');
      document.getElementById('phone-input').value = voter.Phone || '';
      document.getElementById('email-input').value = voter.Email || '';
      document.getElementById('notes-input').value = voter.Notes || '';
      document.getElementById('modal').style.display = 'block';
    }

    document.getElementById('save-btn').onclick = async () => {
      if (!currentVoter) return;
      currentVoter.Phone = document.getElementById('phone-input').value;
      currentVoter.Email = document.getElementById('email-input').value;
      currentVoter.Notes = document.getElementById('notes-input').value;

      console.log("Would POST updated voter:", currentVoter);

      document.getElementById('modal').style.display = 'none';
    };

    document.getElementById('close-btn').onclick = () => {
      document.getElementById('modal').style.display = 'none';
    };
  </script>
</body>
</html>
